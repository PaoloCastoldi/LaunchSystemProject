function [mv,mnew,cg,CM,Axial_aero,Shear_aero,Tz,Tn,nz,nx,Maero,deltah_ox,deltah_rp1] = aerodynamic(const_prop,location,const_aero,mv,r,a,cg,alpha,gamma)
%AERODYNAMIC  Calculates aerodynamic loads and updates vehicle state
%   Computes time-dependent aerodynamic forces, updates propellant mass and
%   CG due to consumption, calculates required thrust for trim, and determines
%   load factors during flight.
%
% Inputs:
%   const_prop : [1, 7] propulsion constants [m_dot_lox, m_dot_rp1, m_ox, m_rp1, rho_lox, rho_rp1, thrust]
%   location   : [1, 5] flight state [time, altitude, velocity, Mach, dynamic_pressure]
%   const_aero : [1, 6] aerodynamic coefficients [Cn_fin_ant, Cd_fin_ant, Cn_tail, Cd_tail, Cn_nose, Cn_inter]
%   mv         : [n, 1] mass vector of components [kg]
%   r          : [n, 1] radius vector [m]
%   a          : [n, 1] area vector [m^2]
%   cg         : [n, 1] center of gravity positions [m]
%   alpha      : [1, 1] angle of attack [rad]
%   gamma      : [1, 1] flight path angle [rad]
%
% Outputs:
%   mv          : [n, 1] updated mass vector [kg]
%   mnew        : [1, 1] current total vehicle mass [kg]
%   cg          : [n, 1] updated CG positions [m]
%   CM          : [1, 1] overall vehicle center of mass [m]
%   Axial_aero  : [1,11] axial aerodynamic loads per segment [N]
%   Shear_aero  : [1,11] shear aerodynamic loads per segment [N]
%   Tz          : [1, 1] lateral thrust component for trim [N]
%   Tn          : [1, 1] normal thrust component [N]
%   nz          : [1, 1] lateral load factor
%   nx          : [1, 1] axial load factor
%   Maero       : [1, 1] total aerodynamic moment [N⋅m]
%   deltah_ox   : [1, 1] change in LOX liquid height [m]
%   deltah_rp1  : [1, 1] change in RP-1 liquid height [m]

g0 = 9.80665;  % Standard gravity [m/s^2]

% Extract flight conditions
t = location(1);  % Current time [s]
q = location(5);  % Dynamic pressure [Pa]

% Extract propulsion constants
m_dot_lox_s1 = const_prop(1);   % LOX mass flow rate [kg/s]
m_dot_rp1_s1 = const_prop(2);   % RP-1 mass flow rate [kg/s]
m_ox_stage1 = const_prop(3);    % Initial LOX mass [kg]
m_rp1_stage1 = const_prop(4);   % Initial RP-1 mass [kg]
rho_lox = const_prop(5);        % LOX density [kg/m^3]
rho_rp1 = const_prop(6);        % RP-1 density [kg/m^3]
thrust = const_prop(7);         % Total thrust [N]

% Extract aerodynamic coefficients
Cn_fin_ant = const_aero(1);         % Normal force coefficient, forward fins
Cd_fin_ant = const_aero(2);         % Drag coefficient, forward fins
Cn_tail = const_aero(3);            % Normal force coefficient, tail fins
Cd_tail = const_aero(4);            % Drag coefficient, tail fins
Cn_alpha_nose = const_aero(5);      % Normal force slope, nose cone [1/deg]
Cn_alpha_intertage = const_aero(6); % Normal force coefficient, interstage

%% UPDATE PROPELLANT MASS AND CENTER OF GRAVITY
% Calculate remaining propellant mass after consumption
m_ox_stage1 = m_ox_stage1 - m_dot_lox_s1*t;
m_rp1_stage1 = m_rp1_stage1 - m_dot_rp1_s1*t;
m_prop_out = m_dot_lox_s1*t + m_dot_rp1_s1*t;  % Total mass expelled

LOM_effettiva = sum(mv);  % Current lift-off mass (before update)
mv(23) = m_ox_stage1;     % Update LOX mass in vector
mv(26) = m_rp1_stage1;    % Update RP-1 mass in vector

% Calculate change in liquid height due to consumption
% deltah = -Volume_consumed / Tank_cross_sectional_area
deltah_ox = -m_dot_lox_s1*t/rho_lox/(pi*r(22)^2);
deltah_rp1 = -m_dot_rp1_s1*t/rho_rp1/(pi*r(25)^2);

% Update propellant CG (liquid surface drops, CG moves up)
cg_ox_stage1 = cg(23) + deltah_ox;    % New LOX CG
cg_rp1_stage1 = cg(26) + deltah_rp1;  % New RP-1 CG
cg(23) = cg_ox_stage1;
cg(26) = cg_rp1_stage1;

% Calculate overall vehicle center of mass
CM_num = sum(mv.*cg);             % Weighted sum: Σ(m_i * cg_i)
mnew = LOM_effettiva - m_prop_out; % Current vehicle mass
CM = CM_num/mnew;                  % Overall CM location

%% CALCULATE AERODYNAMIC FORCES
% Component geometries
D_fwd_skirt = r(4)*2;      % Forward skirt diameter [m]
D_interstage = r(19)*2;    % Interstage diameter [m]

% Normal forces (perpendicular to velocity vector)
L_nose = Cn_alpha_nose*rad2deg(alpha)*q*pi*(D_fwd_skirt^2)/4;  % Nose lift
L_inter = Cn_alpha_intertage*alpha*q*pi*(D_interstage^2-D_fwd_skirt^2)/4;  % Interstage lift
L_fins_ant = 2*sqrt(2)/2*Cn_fin_ant*q*a(13);  % Forward fins lift (4 fins at 45°)
L_tails = 2*sqrt(2)/2*Cn_tail*q*a(28);        % Tail fins lift (4 fins at 45°)

% Drag forces (parallel to velocity vector)
% Drag = 0.7 * q * frontal_area (empirical correction factor 0.7)
Drag = [];
for i = [a(1), zeros(1,5), a(19), zeros(1,4)]
    Drag = [Drag, 0.7*q*i];
end
Drag(6) = 2*sqrt(2)/2*Cd_fin_ant*q*a(13);  % Forward fins drag
Drag(11) = 2*sqrt(2)/2*Cd_tail*q*a(28);    % Tail fins drag

%% TRANSFORM TO BODY AXIS
% Convert lift and drag from wind axis to body axis
% Body axis aligned with vehicle centerline
Axial_aero = Drag*cos(alpha) + ...
    [-L_nose*sin(alpha), 0, 0, 0, 0, -L_fins_ant*sin(alpha), ...
     -L_inter*sin(alpha), 0, 0, 0, -L_tails*sin(alpha)];

Shear_aero = Drag*sin(alpha) + ...
    [L_nose*cos(alpha), 0, 0, 0, 0, L_fins_ant*cos(alpha), ...
     L_inter*cos(alpha), 0, 0, 0, L_tails*cos(alpha)];

% Extract CG positions for each structural segment
cg_s = [cg(1), cg(4), cg(7), cg(9), cg(10), cg(12), cg(19), cg(22), cg(24), cg(25), cg(27)];

%% CALCULATE THRUST FOR TRIM
% Determine lateral thrust component needed to balance aerodynamic moments
[Tz, nz, Maero] = thrust_eq(Shear_aero, cg_s, cg(33), CM, mnew, gamma);

% Calculate gimbal angle and thrust components
delta = asin(Tz/thrust);      % Gimbal angle [rad]
Tn = thrust*cos(delta);       % Normal thrust component [N]

% Calculate axial load factor from force balance
% nx*mg = Thrust - Weight_component - Drag
nx = (Tn - mnew*g0*sin(gamma) - sum(Axial_aero))/(mnew*g0);

end
